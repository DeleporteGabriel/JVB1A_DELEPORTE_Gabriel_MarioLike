<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" /><title>Mon 3eme jeu Phaser</title>
    <script src="phaser.min.js">

    </script>

    </script>

    <style type="text/css"> body 
    
        { margin: 0; }
    
    </style>
</head>
<body>
<script type="text/javascript">


class sceneTest extends Phaser.Scene{
    constructor(){
        super('sceneTest');
    }

        preload(){
            //marcel
            this.load.image('MarcelIdle', 'assets/Marcel idle2.png');
            this.load.image('plateformeTest', 'assets/plateforme test.png');
            this.load.image('background', 'assets/fond de fou.png');

            this.load.image('fireblast', 'assets/le FEU.png')
            this.load.image('grosFeu', 'assets/FEU.png')
            this.load.image('jaugeFeu', 'assets/leFEU3.png')

            this.load.spritesheet('marcel_walk', 'assets/Marcel run left.png',
            { frameWidth: 600, frameHeight: 600 });
            this.load.spritesheet('marcel_eyeattack', 'assets/Marcel FireBlast.png',
            { frameWidth: 600, frameHeight: 600 });

            //ennemy
            this.load.image('francois', 'assets/placeholder_mechant.png');

            //collisions tiled
            this.load.image("Phaser_Collision", "assets/tileset_chambord.png");
            this.load.tilemapTiledJSON("carte", "assets/tiled_export.json");
            this.load.image('image_fond', 'assets/fond complet.png')
        }

        create(){

            this.add.image(6000, 4500, 'image_fond');

            //COLLISIONS//
            const carteDuNiveau = this.add.tilemap("carte");

            // importer TileSet 
            const tileset = carteDuNiveau.addTilesetImage(
                    "tileset_chambord",
                    "Phaser_Collision"
                    );                    
            this.wallGroupe = carteDuNiveau.createLayer(
                    "layer_walls",
                    tileset
                );
            const wallDeco = carteDuNiveau.createLayer(
                    "layer_deco",
                    tileset
                );
            const wallFire = carteDuNiveau.createLayer(
                    "layer_fire",
                    tileset
                );
            this.wallGroupe.setCollisionByProperty({ solide: true });
            wallFire.setCollisionByProperty({ solide: true });

            //PLAYER//
            this.cursors = this.input.keyboard.createCursorKeys();

            this.player = this.physics.add.sprite(2000, 100, 'MarcelIdle');
            this.player.setSize(350, 550)
            this.player.setOffset(125, 50)  
            this.player.body.setMaxVelocity(9999, 4000);

            this.attaquePlayer = false;
            this.timerAttack = 0;
            this.doubleJump = true;

            //animation
            this.anims.create({
                key: 'MarcelLeftRun',
                frames: this.anims.generateFrameNumbers('marcel_walk', {start:0,end:3}),
                frameRate: 10,
                repeat: -1
            });
            this.anims.create({
                key: 'MarcelAttak',
                frames: this.anims.generateFrameNumbers('marcel_eyeattack', {start:0,end:3}),
                frameRate: 5,
                repeat: -1
            });

            //FEU
            this.fired = this.physics.add.group();
            this.firedGround = this.physics.add.group();
            this.flameDispo = 0;

            this.flameJauge = this.physics.add.sprite(-2000, -1000, 'jaugeFeu');
            this.flameJauge.body.allowGravity = false;
            this.flameJauge.body.stop()
            this.flameJauge.setScrollFactor(0);

            function firedCreate(fire, wall) {
                fire.destroy();
                this.grosFeu = this.firedGround.create(fire.x, fire.y - 150, 'grosFeu');
                this.grosFeu.health = 100;
            }

            this.physics.add.collider(this.fired, this.wallGroupe, firedCreate, null, this);
            this.physics.add.collider(this.firedGround, this.wallGroupe);

            this.physics.world.setFPS(300);
            this.physics.add.collider(this.player, this.wallGroupe);

            this.cameras.main.zoom = 0.2;

            this.cameras.main.setBounds(0, 0, 12000, 9000);
            this.cameras.main.startFollow(this.player);

            //MECHANT
            this.ennemy = this.physics.add.sprite(12000, 100, 'francois');
            this.timerAttaque = 0;
            this.timerDash = 0;

            this.AUFEU = false;
            this.timerFeu = 0;
            this.fuiteFeu = 0;

            this.physics.add.collider(this.ennemy, this.wallGroupe);
            this.physics.add.collider(this.ennemy, wallFire);

            function OFEU(ennemy, feu) {
                this.AUFEU = true;
                if (ennemy.x <= feu.x) {this.fuiteFeu = 1;}
                else if (ennemy.x > feu.x) {this.fuiteFeu = 2;}
                else {this.fuiteFeu = 0;}
            }

            this.physics.add.overlap(this.ennemy, this.firedGround, OFEU, null, this);
    
            
        };

        update(time, delta){
            super.update(time, delta);

            //CONTROLE MARCEL//
            this.jump = Phaser.Input.Keyboard.JustDown(this.cursors.up);

            if (this.attaquePlayer == false) {
                if (this.player.body.blocked.down) {
                    this.doubleJump = true;
                }
                if (this.jump)
                {   
                    if (this.player.body.blocked.down) {
                        this.player.setVelocityY(-3000);
                    }
                    else if (this.doubleJump == true) {
                        this.player.setVelocityY(-3000);
                        this.doubleJump = false;
                    }
                }  
                if (this.cursors.left.isDown){ //si la touche gauche est appuyée
                    this.player.setVelocityX(-1800); //alors vitesse négative en X
                    this.player.anims.play('MarcelLeftRun', true);
                    this.player.flipX = false;
                }
                else if (this.cursors.right.isDown){ //sinon si la touche droite est appuyée
                    this.player.setVelocityX(1800); //alors vitesse positive en X
                    this.player.anims.play('MarcelLeftRun', true);
                    this.player.flipX = true;
                }
                else{ // sinon
                    this.player.setVelocityX(0); //vitesse nulle
                    this.player.setTexture('MarcelIdle');
                }

                if (this.player.body.blocked.right) {
                    //this.player.x += 20;
                    this.tile = this.wallGroupe.getTileAtWorldXY(this.player.x + 300, this.player.y - 300, true);
                    if (this.tile.index == -1){
                        this.player.body.y -= 150;
                    }
                }
                if (this.player.body.blocked.left) {
                    //this.player.x -= 20;
                    this.tile = this.wallGroupe.getTileAtWorldXY(this.player.x - 300, this.player.y - 300, true);
                    if (this.tile.index == -1){
                        this.player.body.y -= 150;;
                    }
                }

                if ((this.cursors.space.isDown) && (this.flameDispo == 0)) {
                    this.flameDispo++;
                    this.attaquePlayer = true;
                    this.player.anims.play({ key: 'MarcelAttak', startFrame: 0 }, true);
                }
            }
            else {
                this.player.setVelocityX(0);
                this.timerAttack++;
                if (this.timerAttack == 10) {
                if (this.cursors.down.isDown) {
                    this.feu = this.fired.create(this.player.x, this.player.y - 100, 'fireblast');
                        this.feu.setVelocityY(4000);
                }
                else {
                    if (this.player.flipX == false) {
                        this.feu = this.fired.create(this.player.x - 100, this.player.y - 100, 'fireblast');
                        this.feu.setVelocityX(-4000);
                    } else {
                        this.feu = this.fired.create(this.player.x + 100, this.player.y - 100, 'fireblast');
                        this.feu.setVelocityX(4000);
                    }
                }
                }
                if (this.timerAttack >= 40) {
                    this.attaquePlayer = false;
                    this.timerAttack = 0;
                }
            }

            //FEU
            if (this.flameDispo != 0) {
                this.flameDispo++;
                this.flameJauge.alpha = this.flameDispo/200;
                if (this.flameDispo >= 150) {
                    this.flameDispo = 0;
                    this.flameJauge.alpha = 1;
                }
            }

            this.firedGround.children.each(function(feu) {
                feu.health -= 1;
                if (feu.health < 40) {feu.alpha -= 0.05;}
                if (feu.health <= 0) {
                    feu.destroy();
                }
            }, this);

            //MECHANT PATTERN
            if (this.AUFEU == false) {
            if (this.timerDash == 0) {
                if ((this.ennemy.y > this.player.y + 100) || (this.ennemy.y < this.player.y - 100)) {
                    if ((this.ennemy.x < this.player.x)) {
                        this.ennemy.setVelocityX(800);
                        this.timerAttaque = 0;
                    }
                    else if ((this.ennemy.x > this.player.x)) {
                        this.ennemy.setVelocityX(-800);
                        this.timerAttaque = 0;
                    }
                    else {this.ennemy.setVelocityX(0); this.timerAttaque++;}
                }
                else {                
                    if ((this.ennemy.x < this.player.x - 600)) {
                        this.ennemy.setVelocityX(800);
                        this.timerAttaque = 0;
                    }
                    else if ((this.ennemy.x > this.player.x + 600)) {
                        this.ennemy.setVelocityX(-800);
                        this.timerAttaque = 0;
                    }
                    else {this.ennemy.setVelocityX(0); this.timerAttaque++;}
                }
            }
            if (this.timerAttaque >= 20) {
                this.timerAttaque = 0;
                this.timerDash++;
                if (this.ennemy.x < this.player.x) {
                    this.ennemy.setVelocityX(3000);
                }
                else if (this.ennemy.x > this.player.x) {
                    this.ennemy.setVelocityX(-3000);
                }
            }
            if (this.timerDash != 0) {
                this.timerDash++;
                if (this.timerDash >= 25) {
                    this.timerDash = 0;
                    this.ennemy.setVelocityX(0);
                }
            }
            } else {
                this.timerFeu++;
                if (this.timerFeu >= 50) {this.timerFeu = 0; this.AUFEU = false; this.fuiteFeu = 0;}

                if (this.fuiteFeu == 1) {this.ennemy.setVelocityX(-4000);}
                else if (this.fuiteFeu == 2) {this.ennemy.setVelocityX(4000);}
            }
            if ((this.ennemy.body.blocked.right) || (this.ennemy.body.blocked.left)) {
                this.ennemy.setVelocityY(-2000);
            }

        };
}

var config = {
        type: Phaser.CANVA,
        width: 1280, height: 720,
        physics: {
        default: 'arcade',
        arcade: {
        gravity: { y: 10000 },
        debug: false
        }},
        pixelArt: true,
        roundPixels: true,
        scene: [sceneTest]
        };

        new Phaser.Game(config);

</script>
</body>
    
</html>